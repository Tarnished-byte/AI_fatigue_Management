<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel-AI | Proactive Safety Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* bg-gray-100 */
            color: #1f2937;
            /* text-gray-800 */
        }

        .main-container {
            grid-template-columns: auto 1fr;
        }

        .sidebar {
            background-color: #ffffff;
            /* bg-white */
            border-right: 1px solid #e5e7eb;
            /* border-gray-200 */
        }

        .nav-item {
            transition: all 0.2s ease-in-out;
            color: #4b5563;
            /* text-gray-600 */
        }

        .nav-item.active,
        .nav-item:hover {
            background-color: #eef2ff;
            /* bg-indigo-50 */
            color: #4338ca;
            /* text-indigo-700 */
        }

        .nav-item.active svg,
        .nav-item:hover svg {
            color: #6366f1;
            /* text-indigo-500 */
        }

        .content-card {
            background-color: #ffffff;
            /* bg-white */
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 20px;
        }

        /* New vibrant risk colors */
        .risk-low {
            color: #166534;
        }

        .border-risk-low {
            border-color: #4ade80;
        }

        .bg-risk-low {
            background-color: #1edd11ab;
        }

        .risk-moderate {
            color: #854d0e;
        }

        .border-risk-moderate {
            border-color: #facc15;
        }

        .bg-risk-moderate {
            background-color: #ffe600ad;
        }

        .risk-high {
            color: #991b1b;
        }

        .border-risk-high {
            border-color: #f87171;
        }

        .bg-risk-high {
            background-color: #f20000a0;
        }

        .page,
        #login-page,
        #app-container {
            display: none;
        }

        .page.active,
        #login-page.active,
        #app-container.active {
            display: block;
        }

        #app-container.active {
            display: grid;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page.active,
        #login-page.active {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .health-indicator-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .health-indicator {
            position: absolute;
            border-radius: 9999px;
            opacity: 0.7;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s ease-in-out;
        }

        /* Repositioned circles for the new image */
        #health-head {
            top: 10%;
            left: 45.7%;
            width: 9%;
            padding-bottom: 9%;
        }

        #health-torso {
            top: 22%;
            left: 39%;
            width: 22%;
            padding-bottom: 22%;
        }

        #health-left-arm {
            top: 33%;
            left: 26.25%;
            width: 9%;
            padding-bottom: 9%;
        }

        #health-right-arm {
            top: 33%;
            left: 63%;
            width: 9%;
            padding-bottom: 9%;
        }

        #health-left-leg {
            top: 60%;
            left: 35%;
            width: 11%;
            padding-bottom: 11%;
        }

        #health-right-leg {
            top: 60%;
            left: 53%;
            width: 11%;
            padding-bottom: 11%;
        }
    </style>
</head>

<body class="h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="text-lg font-semibold text-gray-700">Initializing Sentinel Platform...</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="h-full flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div class="text-center">
                <svg class="h-12 w-12 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
                    <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" />
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                </svg>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">Welcome to Sentinel</h2>
                <p class="mt-2 text-sm text-gray-500">Proactive Safety Monitoring</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700">Username</label>
                    <input id="username" name="username" type="text" value="supervisor@sentinel.io" required
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" value="password" required
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button type="submit"
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white font-semibold transition-colors">Sign
                    In</button>
            </form>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <svg class="h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M15 12h.01" />
                        <path d="M10.34 6.34 12 4.67l1.66 1.67" />
                        <path d="m13.66 17.66 1.67 1.67 1.67-1.67" />
                        <path d="M12 22a10 10 0 0 1-10-10 10 10 0 0 1 10-10 10 10 0 0 1 10 10 10 10 0 0 1-10 10z" />
                        <path d="m4.67 12 1.66-1.67L4.67 8.67" />
                        <path d="m17.66 13.66-1.67-1.67-1.67 1.67" />
                    </svg>
                    AI Safety Assistant
                </h3>
                <button id="close-ai-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div id="ai-modal-content" class="p-6 overflow-y-auto custom-scrollbar space-y-6">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="grid main-container h-full">
        <!-- Sidebar Navigation -->
        <nav class="sidebar w-20 xl:w-64 flex flex-col p-4 items-center xl:items-start justify-between">
            <div>
                <div class="flex items-center gap-3 mb-10 w-full h-10 px-2">
                    <svg class="h-8 w-8 text-indigo-500 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24"
                        height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
                        <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" />
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-800 hidden xl:block">Sentinel</h1>
                </div>
                <ul class="space-y-3 w-full">
                    <li><a href="#" class="nav-item active flex items-center gap-4 p-3 rounded-lg"
                            data-page="dashboard"><svg class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg"
                                width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="7" height="9" x="3" y="3" rx="1" />
                                <rect width="7" height="5" x="14" y="3" rx="1" />
                                <rect width="7" height="9" x="14" y="12" rx="1" />
                                <rect width="7" height="5" x="3" y="16" rx="1" />
                            </svg><span class="hidden xl:block font-medium">Dashboard</span></a></li>
                    <li><a href="#" class="nav-item flex items-center gap-4 p-3 rounded-lg" data-page="analytics"><svg
                                class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" x2="18" y1="20" y2="10" />
                                <line x1="12" x2="12" y1="20" y2="4" />
                                <line x1="6" x2="6" y1="20" y2="14" />
                            </svg><span class="hidden xl:block font-medium">Analytics</span></a></li>
                    <li><a href="#" class="nav-item flex items-center gap-4 p-3 rounded-lg" data-page="team"><svg
                                class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg><span class="hidden xl:block font-medium">Team Overview</span></a></li>
                    <li><a href="#" class="nav-item flex items-center gap-4 p-3 rounded-lg" data-page="alerts"><svg
                                class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
                                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                            </svg><span class="hidden xl:block font-medium">Alerts Center</span></a></li>
                </ul>
            </div>
            <div>
                <a href="#" class="nav-item flex items-center gap-4 p-3 rounded-lg" data-page="settings"><svg
                        class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg><span class="hidden xl:block font-medium">Settings</span></a>
                <div id="logout-button" class="mt-4 border-t border-gray-200 pt-4 cursor-pointer">
                    <div class="nav-item flex items-center gap-4 p-3 rounded-lg">
                        <svg class="h-6 w-6 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" x2="9" y1="12" y2="12" />
                        </svg>
                        <span class="hidden xl:block font-medium">Logout</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="overflow-y-auto custom-scrollbar">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Live Dashboard</h2>
                    <p class="text-gray-500 mt-1">Real-time physiological and environmental monitoring.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 content-card p-4">
                        <h3 class="font-semibold text-gray-800 px-2 mb-3">On-site Team Members</h3>
                        <div id="worker-list" class="space-y-2 h-[75vh] overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="content-card p-6 flex flex-col items-center justify-center text-center">
                                <img id="worker-avatar" src="" class="rounded-full h-24 w-24 mb-4 border-4">
                                <h3 id="worker-name" class="text-xl font-semibold text-gray-900"></h3>
                                <p id="worker-id" class="text-gray-500 text-sm"></p>
                                <div id="worker-status-badge"
                                    class="mt-4 text-sm font-medium py-1.5 px-4 rounded-full flex items-center gap-2">
                                    <span id="worker-status-text"></span></div>
                            </div>
                            <div class="md:col-span-2 content-card p-6">
                                <h4 class="font-semibold text-gray-900 mb-4">Current Vitals & Environment</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center gap-3"><svg class="h-6 w-6 text-red-500"
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path
                                                d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                                        </svg>
                                        <div>
                                            <div class="text-xs text-gray-500">HRV</div><span id="vital-hrv"
                                                class="font-semibold text-lg text-gray-800"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3"><svg class="h-6 w-6 text-blue-500"
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />
                                        </svg>
                                        <div>
                                            <div class="text-xs text-gray-500">Temp.</div><span id="env-temp"
                                                class="font-semibold text-lg text-gray-800"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3"><svg class="h-6 w-6 text-green-500"
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path
                                                d="M12.24 12.24a6 6 0 0 0 7.76 7.76 6 6 0 0 0-7.76-7.76L12 12l-7.76 7.76a6 6 0 0 0 7.76 7.76Z" />
                                            <path d="m14 14-2.5 2.5" />
                                            <path d="m14 14 2.5-2.5" />
                                            <path d="m14 14-2.5-2.5" />
                                            <path d="m14 14 2.5 2.5" />
                                            <path d="M22 12c0 6-6 6-6 6s-6-6-6-6c0-6 6-6 6-6s6 6 6 6Z" />
                                            <path d="M16 12a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z" />
                                        </svg>
                                        <div>
                                            <div class="text-xs text-gray-500">CO₂</div><span id="env-co2"
                                                class="font-semibold text-lg text-gray-800"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3"><svg class="h-6 w-6 text-yellow-500"
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 8a4 4 0 0 0-4 4h8a4 4 0 0 0-4-4z" />
                                            <path d="M5 12a7 7 0 0 0 7 7 7 7 0 0 0 7-7" />
                                            <path d="M12 19v2" />
                                        </svg>
                                        <div>
                                            <div class="text-xs text-gray-500">Noise</div><span id="env-noise"
                                                class="font-semibold text-lg text-gray-800"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-card p-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Live Heart Rate Variability (HRV)</h4>
                            <div class="h-64"><canvas id="hrvChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Health Page -->
            <div id="health" class="page p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Worker Health Monitoring</h2>
                    <p class="text-gray-500 mt-1">Detailed physiological status for <span id="health-worker-name"
                            class="font-semibold text-gray-800"></span>.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-10rem)]">
                    <div class="content-card p-6 flex items-center justify-center">
                        <div class="health-indicator-wrapper">
                            <img src="manniquine.jpg" alt="Human Body" class="w-[1020px] h-auto object-contain">
                            <div id="health-head" class="health-indicator"></div>
                            <div id="health-torso" class="health-indicator"></div>
                            <div id="health-left-arm" class="health-indicator"></div>
                            <div id="health-right-arm" class="health-indicator"></div>
                            <div id="health-left-leg" class="health-indicator"></div>
                            <div id="health-right-leg" class="health-indicator"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="content-card p-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Physiological Status</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Cognitive Strain</div>
                                    <div id="health-strain" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Core Temperature</div>
                                    <div id="health-core-temp" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Skin Temperature</div>
                                    <div id="health-skin-temp" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Heart Rate</div>
                                    <div id="health-hr" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Oxygen Sat. (SpO2)</div>
                                    <div id="health-spo2" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Movement Level</div>
                                    <div id="health-movement" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                            </div>
                        </div>
                        <div class="content-card p-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Environmental Data</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Ambient Temp.</div>
                                    <div id="health-env-temp" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Air Quality (AQI)</div>
                                    <div id="health-env-aqi" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Humidity</div>
                                    <div id="health-env-humidity" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">CO₂ Levels</div>
                                    <div id="health-env-co2" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="text-sm text-gray-500">Noise Level</div>
                                    <div id="health-env-noise" class="text-2xl font-bold text-gray-800"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Analytics Page -->
            <div id="analytics" class="page p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Worker Analytics</h2>
                    <p class="text-gray-500 mt-1">Historical data and performance trends for <span
                            id="analytics-worker-name" class="font-semibold text-gray-800"></span>.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="content-card p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">HRV & Stress Events (Last Hour)</h4>
                        <div class="h-80"><canvas id="analyticsHrvChart"></canvas></div>
                    </div>
                    <div class="content-card p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">Environmental Exposure (Last Hour)</h4>
                        <div class="h-80"><canvas id="analyticsEnvChart"></canvas></div>
                    </div>
                </div>
            </div>
            <!-- Team Page -->
            <div id="team" class="page p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Team Overview</h2>
                    <p class="text-gray-500 mt-1">Aggregate metrics for all on-site personnel.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-2 content-card p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">Team Risk Distribution</h4>
                        <div class="h-80 flex items-center justify-center"><canvas id="teamRiskChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-3 content-card p-6">
                        <h4 class="font-semibold text-gray-900 mb-4">Team Average HRV (Last Hour)</h4>
                        <div class="h-80"><canvas id="teamHrvChart"></canvas></div>
                    </div>
                </div>
            </div>
            <!-- Alerts Page -->
            <div id="alerts" class="page p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Alerts Center</h2>
                    <p class="text-gray-500 mt-1">A log of all system-generated alerts.</p>
                </header>
                <div class="content-card p-6">
                    <div id="alert-log" class="space-y-4 h-[75vh] overflow-y-auto custom-scrollbar pr-2 text-sm"></div>
                </div>
            </div>
            <!-- Settings Page -->
            <div id="settings" class="page p-8">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Settings</h2>
                    <p class="text-gray-500 mt-1">Configure your platform preferences.</p>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="content-card p-8">
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">Notifications</h4>
                                <p class="text-sm text-gray-500">Manage how you receive alerts.</p>
                            </div>
                            <div class="flex items-center justify-between"><span class="font-medium text-gray-700">Email
                                    Alerts</span><label class="relative inline-flex items-center cursor-pointer"><input
                                        type="checkbox" value="" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                    </div>
                                </label></div>
                            <div class="flex items-center justify-between"><span
                                    class="font-medium text-gray-700">Desktop Push Notifications</span><label
                                    class="relative inline-flex items-center cursor-pointer"><input type="checkbox"
                                        value="" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                                    </div>
                                </label></div>
                        </div>
                    </div>
                    <div class="content-card p-8">
                        <form id="api-key-form" class="space-y-6">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">AI Configuration</h4>
                                <p class="text-sm text-gray-500">Manage your Gemini API Key.</p>
                            </div>
                            <div>
                                <label for="api-key-input" class="text-sm font-medium text-gray-700">Gemini API
                                    Key</label>
                                <input id="api-key-input" type="password" placeholder="Enter your API key"
                                    class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <p class="text-xs text-gray-400 mt-1">Your key is stored securely in your browser's
                                    local storage.</p>
                            </div>
                            <div class="text-right">
                                <button type="submit"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors">Save
                                    Key</button>
                            </div>
                            <div id="api-key-status" class="text-sm"></div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        // --- Application State ---
        let selectedWorkerId = 3;
        let currentPage = 'dashboard';
        const workers = [];
        const charts = {};

        const riskConfig = {
            Low: { text: 'Low Risk', class: 'risk-low', border: 'border-risk-low', bg: 'bg-risk-low' },
            Moderate: { text: 'Moderate Risk', class: 'risk-moderate', border: 'border-risk-moderate', bg: 'bg-risk-moderate' },
            High: { text: 'High Risk', class: 'risk-high', border: 'border-risk-high', bg: 'bg-risk-high' },
        };

        // --- Initial Data Generation ---
        function generateInitialData() {
            const names = ["John Doe", "Jane Smith", "Peter Jones", "Sue Williams", "Mike Brown", "Emily Clark", "David Lee", "Sarah Chen"];
            names.forEach((name, index) => {
                const riskLevels = ['Low', 'Moderate', 'High'];
                const risk = riskLevels[index % 3];
                let hrv = 70 - (index % 3) * 15;

                const worker = {
                    id: index + 1, name: name, short: name.split(' ').map(n => n[0]).join(''), risk: risk, hrv: hrv,
                    temp: 24 + Math.random() * 2, co2: 450 + Math.random() * 100, noise: 60 + Math.random() * 5,
                    status: risk === 'High' ? "Fatigue Detected" : (risk === 'Moderate' ? "Drowsiness Alert" : "Normal"),
                    hrvHistory: [], co2History: [],
                    health: {
                        strain: (risk === 'High' ? 85 : (risk === 'Moderate' ? 60 : 25)) + Math.random() * 5,
                        coreTemp: 37.0 + (index % 3) * 0.2 + (Math.random() - 0.5) * 0.1,
                        skinTemp: 34.0 + (index % 3) * 0.3 + (Math.random() - 0.5) * 0.2,
                        hr: 70 + (index % 3) * 10 + Math.random() * 5,
                        spo2: 98 - (index % 3) * 1,
                        movement: risk === 'High' ? 'Low' : 'Normal',
                        aqi: 25 + Math.random() * 10,
                        humidity: 55 + Math.random() * 10,
                    }
                };
                const now = new Date();
                for (let i = 0; i < 60; i++) {
                    const timestamp = new Date(now.getTime() - (60 - i) * 60000);
                    worker.hrvHistory.push({ x: timestamp, y: worker.hrv + (Math.random() - 0.5) * 5 });
                    worker.co2History.push({ x: timestamp, y: worker.co2 + (Math.random() - 0.5) * 50 });
                }
                workers.push(worker);
            });
        }

        // --- Page Navigation & Auth ---
        function navigateTo(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navButton = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navButton) {
                navButton.classList.add('active');
            }

            updatePageContent();
        }

        function handleLogin(e) {
            e.preventDefault();
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('app-container').classList.add('active');
        }

        function handleLogout() {
            document.getElementById('app-container').classList.remove('active');
            document.getElementById('login-page').classList.add('active');
            navigateTo('dashboard'); // Reset to default page on logout
        }

        // --- Render Functions ---
        function renderAll() {
            renderWorkerList();
            updatePageContent();
        }

        function updatePageContent() {
            const worker = workers.find(w => w.id === selectedWorkerId);
            if (!worker) return;
            switch (currentPage) {
                case 'dashboard': renderDashboard(worker); break;
                case 'health': renderHealth(worker); break;
                case 'analytics': renderAnalytics(worker); break;
                case 'team': renderTeamView(); break;
                case 'alerts': renderAlerts(); break;
                case 'settings': renderSettings(); break;
            }
        }

        function renderWorkerList() {
            const listEl = document.getElementById('worker-list');
            if (!listEl) return; // FIX: Guard clause to prevent error on other pages
            listEl.innerHTML = workers.map(w => `
            <div id="worker-${w.id}" class="worker-item p-3 rounded-lg cursor-pointer flex items-center justify-between transition-all duration-200 ${selectedWorkerId === w.id && currentPage === 'dashboard' ? 'bg-indigo-500 shadow-lg' : 'hover:bg-gray-100'}">
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/40x40/eef2ff/4338ca?text=${w.short}" class="worker-pfp rounded-full h-10 w-10" data-id="${w.id}">
                    <div>
                        <p class="font-semibold ${selectedWorkerId === w.id && currentPage === 'dashboard' ? 'text-white' : 'text-gray-800'}">${w.name}</p>
                        <p class="text-xs ${selectedWorkerId === w.id && currentPage === 'dashboard' ? 'text-indigo-200' : 'text-gray-500'}">ID: WKR-00${w.id}</p>
                    </div>
                </div>
                <span class="text-xs font-bold py-1 px-2 rounded-md ${riskConfig[w.risk].class} ${riskConfig[w.risk].bg}">${w.risk}</span>
            </div>
        `).join('');

            document.querySelectorAll('.worker-item').forEach(item => {
                const workerId = parseInt(item.id.split('-')[1]);
                item.addEventListener('click', () => {
                    selectedWorkerId = workerId;
                    if (currentPage !== 'dashboard') {
                        navigateTo('dashboard');
                    }
                    renderAll();
                });
                item.addEventListener('dblclick', () => {
                    selectedWorkerId = workerId;
                    navigateTo('health');
                });
            });

            document.querySelectorAll('.worker-pfp').forEach(pfp => {
                pfp.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedWorkerId = parseInt(pfp.dataset.id);
                    navigateTo('health');
                });
            });
        }

        function renderDashboard(worker) {
            document.getElementById('worker-avatar').src = `https://placehold.co/100x100/eef2ff/4338ca?text=${worker.short}`;
            document.getElementById('worker-avatar').className = `rounded-full h-24 w-24 mb-4 border-4 ${riskConfig[worker.risk].border}`;
            document.getElementById('worker-name').textContent = worker.name;
            document.getElementById('worker-id').textContent = `ID: WKR-00${worker.id}`;
            const badge = document.getElementById('worker-status-badge');
            badge.className = `mt-4 text-sm font-medium py-1.5 px-4 rounded-full flex items-center gap-2 ${riskConfig[worker.risk].bg} ${riskConfig[worker.risk].class}`;
            document.getElementById('worker-status-text').textContent = worker.status;
            document.getElementById('vital-hrv').textContent = `${worker.hrv.toFixed(1)} ms`;
            document.getElementById('env-temp').textContent = `${worker.temp.toFixed(1)}°C`;
            document.getElementById('env-co2').textContent = `${worker.co2.toFixed(0)} ppm`;
            document.getElementById('env-noise').textContent = `${worker.noise.toFixed(1)} dB`;
            if (charts.hrv) {
                charts.hrv.data.datasets[0].data = worker.hrvHistory.slice(-60);
                charts.hrv.update();
            }
        }

        function renderHealth(worker) {
            document.getElementById('health-worker-name').textContent = worker.name;
            const health = worker.health;
            document.getElementById('health-strain').textContent = `${health.strain.toFixed(0)}%`;
            document.getElementById('health-core-temp').textContent = `${health.coreTemp.toFixed(1)}°C`;
            document.getElementById('health-skin-temp').textContent = `${health.skinTemp.toFixed(1)}°C`;
            document.getElementById('health-hr').textContent = `${health.hr.toFixed(0)} bpm`;
            document.getElementById('health-spo2').textContent = `${health.spo2.toFixed(0)}%`;
            document.getElementById('health-movement').textContent = health.movement;
            document.getElementById('health-env-temp').textContent = `${worker.temp.toFixed(1)}°C`;
            document.getElementById('health-env-aqi').textContent = health.aqi.toFixed(0);
            document.getElementById('health-env-humidity').textContent = `${health.humidity.toFixed(0)}%`;
            document.getElementById('health-env-co2').textContent = `${worker.co2.toFixed(0)} ppm`;
            document.getElementById('health-env-noise').textContent = `${worker.noise.toFixed(1)} dB`;

            const riskBg = riskConfig[worker.risk].bg;
            const lowRiskBg = riskConfig['Low'].bg;

            document.getElementById('health-head').className = `health-indicator transition-all duration-300 ${riskBg}`;
            document.getElementById('health-torso').className = `health-indicator transition-all duration-300 ${riskBg}`;
            document.getElementById('health-left-arm').className = `health-indicator transition-all duration-300 ${lowRiskBg}`;
            document.getElementById('health-right-arm').className = `health-indicator transition-all duration-300 ${lowRiskBg}`;
            document.getElementById('health-left-leg').className = `health-indicator transition-all duration-300 ${lowRiskBg}`;
            document.getElementById('health-right-leg').className = `health-indicator transition-all duration-300 ${lowRiskBg}`;
        }

        function renderAnalytics(worker) {
            document.getElementById('analytics-worker-name').textContent = worker.name;
            if (charts.analyticsHrv) {
                charts.analyticsHrv.data.datasets[0].data = worker.hrvHistory;
                charts.analyticsEnv.data.datasets[0].data = worker.co2History;
                charts.analyticsHrv.update();
                charts.analyticsEnv.update();
            }
        }

        function renderTeamView() {
            const totalWorkers = workers.length;
            const riskCounts = workers.reduce((acc, w) => { acc[w.risk]++; return acc; }, { Low: 0, Moderate: 0, High: 0 });
            if (charts.teamRisk) {
                charts.teamRisk.data.datasets[0].data = Object.values(riskCounts);
                charts.teamRisk.options.plugins.tooltip.callbacks.label = (context) => {
                    const label = context.label || '';
                    const value = context.parsed;
                    const percentage = ((value / totalWorkers) * 100).toFixed(1);
                    return `${label}: ${value} (${percentage}%)`;
                };
                charts.teamRisk.update();
            }
            if (charts.teamHrv) {
                const teamHrvHistory = charts.teamHrv.data.datasets[0].data;
                if (teamHrvHistory.length === 0) {
                    workers[0].hrvHistory.slice(-60).forEach(d => { teamHrvHistory.push({ x: d.x, y: workers.reduce((acc, w) => acc + w.hrv, 0) / workers.length }); });
                }
                const now = new Date();
                const teamHrvAvg = workers.reduce((acc, w) => acc + w.hrv, 0) / workers.length;
                teamHrvHistory.push({ x: now, y: teamHrvAvg });
                if (teamHrvHistory.length > 60) teamHrvHistory.shift();
                charts.teamHrv.update();
            }
        }

        function renderAlerts() {
            const alertEl = document.getElementById('alert-log');
            const allAlerts = JSON.parse(localStorage.getItem('sentinelAlerts') || '[]');
            if (allAlerts.length === 0) { alertEl.innerHTML = `<div class="text-gray-500 text-center py-10">No alerts recorded.</div>`; return; }
            alertEl.innerHTML = allAlerts.slice().reverse().map(alert => {
                const alertJSON = JSON.stringify(alert).replace(/'/g, "&apos;");
                const showAIButton = alert.risk === 'Moderate' || alert.risk === 'High';
                return `
            <div class="p-4 rounded-lg flex flex-col gap-4 ${riskConfig[alert.risk].bg}">
                <div class="flex items-start gap-4">
                    <div class="w-1.5 h-full bg-${riskConfig[alert.risk].class.split('-')[1]} rounded-full"></div>
                    <div>
                        <p class="font-medium ${riskConfig[alert.risk].class}">${alert.risk} Risk Event: ${alert.workerName}</p>
                        <p class="text-gray-700">${alert.message}</p>
                        <p class="text-gray-500 text-xs mt-1">${new Date(alert.time).toLocaleString()}</p>
                    </div>
                </div>
                ${showAIButton ? `
                <div class="border-t border-gray-200 pt-3 text-right">
                    <button onclick='getAIAssistance(${alertJSON})' 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-2 px-3 rounded-md transition-colors flex items-center gap-2 ml-auto">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 12h.01"/><path d="M10.34 6.34 12 4.67l1.66 1.67"/><path d="m13.66 17.66 1.67 1.67 1.67-1.67"/><path d="M12 22a10 10 0 0 1-10-10 10 10 0 0 1 10-10 10 10 0 0 1 10 10 10 10 0 0 1-10 10z"/><path d="m4.67 12 1.66-1.67L4.67 8.67"/><path d="m17.66 13.66-1.67-1.67-1.67 1.67"/></svg>
                        ✨ Analyze & Act
                    </button>
                </div>` : ''}
            </div>`}).join('');
        }

        function renderSettings() {
            const apiKey = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('api-key-input').value = apiKey;
            updateApiKeyStatus(apiKey);
        }

        function updateApiKeyStatus(key) {
            const statusEl = document.getElementById('api-key-status');
            if (key) {
                statusEl.innerHTML = `<p class="text-green-600">API Key is set.</p>`;
            } else {
                statusEl.innerHTML = `<p class="text-yellow-600">API Key is not set. AI features are disabled.</p>`;
            }
        }

        // --- Chart Initialization ---
        function initializeCharts() {
            Chart.defaults.color = '#4b5563'; // text-gray-600
            Chart.defaults.borderColor = '#e5e7eb'; // border-gray-200
            if (document.getElementById('hrvChart')) charts.hrv = new Chart(document.getElementById('hrvChart').getContext('2d'), chartConfig('line', [], 'HRV (ms)', true, 'minute'));
            if (document.getElementById('analyticsHrvChart')) charts.analyticsHrv = new Chart(document.getElementById('analyticsHrvChart').getContext('2d'), chartConfig('line', [], 'HRV (ms)', true, 'minute'));
            if (document.getElementById('analyticsEnvChart')) charts.analyticsEnv = new Chart(document.getElementById('analyticsEnvChart').getContext('2d'), chartConfig('line', [], 'CO₂ (ppm)', true, 'minute', 'rgba(34,197,94,0.2)', '#22c55e'));
            if (document.getElementById('teamHrvChart')) charts.teamHrv = new Chart(document.getElementById('teamHrvChart').getContext('2d'), chartConfig('line', [], 'HRV (ms)', true, 'minute'));
            if (document.getElementById('teamRiskChart')) charts.teamRisk = new Chart(document.getElementById('teamRiskChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Low Risk', 'Moderate Risk', 'High Risk'], datasets: [{ data: [], backgroundColor: ['#4ade80', '#facc15', '#f87171'], borderColor: '#ffffff', borderWidth: 4, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20 } }, tooltip: { callbacks: {} } } } });
        }

        function chartConfig(type, data, yLabel, xDisplay, timeUnit, bgColor = 'rgba(99, 102, 241, 0.1)', borderColor = '#6366f1') {
            return { type: type, data: { datasets: [{ label: yLabel, data: data, backgroundColor: bgColor, borderColor: borderColor, fill: true, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#e5e7eb' }, title: { display: true, text: yLabel, color: '#374151' } }, x: { type: 'time', time: { unit: timeUnit, displayFormats: { minute: 'HH:mm' } }, grid: { display: false }, ticks: { display: xDisplay, color: '#4b5563' } } } } };
        }

        // --- Live Data Feed ---
        function runDataFeed() {
            workers.forEach(w => {
                w.hrv += (Math.random() - 0.5) * 1; w.co2 += (Math.random() - 0.5) * 5; w.temp += (Math.random() - 0.5) * 0.1; w.noise += (Math.random() - 0.5) * 2;
                if (w.risk === 'High') w.hrv -= 0.2; if (w.risk === 'Moderate') w.hrv -= 0.1;
                if (w.hrv < 45) w.risk = 'High'; else if (w.hrv < 55) w.risk = 'Moderate'; else w.risk = 'Low';
                const now = new Date();
                w.hrvHistory.push({ x: now, y: w.hrv }); if (w.hrvHistory.length > 60) w.hrvHistory.shift();
                w.co2History.push({ x: now, y: w.co2 }); if (w.co2History.length > 60) w.co2History.shift();
                if (w.risk === 'High' && Math.random() < 0.05) { logAlert(w, 'High', 'Critical HRV drop detected.'); w.status = "Fatigue Detected"; }
                else if (w.risk === 'Moderate' && Math.random() < 0.05) { logAlert(w, 'Moderate', 'Elevated stress indicators observed.'); w.status = "Drowsiness Alert"; }
            });
            renderAll();
        }

        function logAlert(worker, risk, message) {
            const now = new Date();
            const alert = { workerId: worker.id, workerName: worker.name, risk, message, time: now.toISOString() };
            let allAlerts = JSON.parse(localStorage.getItem('sentinelAlerts') || '[]');
            allAlerts.push(alert);
            if (allAlerts.length > 100) allAlerts.shift();
            localStorage.setItem('sentinelAlerts', JSON.stringify(allAlerts));
        }

        // --- Gemini API Integration ---
        async function getAIAssistance(alert) {
            const modal = document.getElementById('ai-modal');
            const modalContent = document.getElementById('ai-modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                modalContent.innerHTML = `
                <div class="text-center p-4">
                    <h4 class="text-lg font-bold text-yellow-700">API Key Not Found</h4>
                    <p class="text-gray-600 mt-2 mb-4">Please add your Gemini API key in the Settings page to use the AI Assistant.</p>
                    <button id="go-to-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md">Go to Settings</button>
                </div>`;
                document.getElementById('go-to-settings').addEventListener('click', () => {
                    modal.classList.add('hidden');
                    navigateTo('settings');
                });
                return;
            }

            modalContent.innerHTML = `
            <div class="text-center">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg font-semibold text-gray-700">Analyzing data and generating recommendations...</p>
            </div>`;

            const worker = workers.find(w => w.id === alert.workerId);
            const userQuery = `
            An industrial worker, ${worker.name}, has triggered a '${alert.risk} Risk' safety alert.
            Alert Message: "${alert.message}"
            Time: ${new Date(alert.time).toLocaleString()}

            Current Physiological Data:
            - Heart Rate Variability (HRV): ${worker.hrv.toFixed(1)} ms
            - Heart Rate: ${worker.health.hr.toFixed(0)} bpm
            - Cognitive Strain: ${worker.health.strain.toFixed(0)}%
            - Core Body Temperature: ${worker.health.coreTemp.toFixed(1)}°C

            Current Environmental Data:
            - Ambient Temperature: ${worker.temp.toFixed(1)}°C
            - CO₂ Level: ${worker.co2.toFixed(0)} ppm
            - Noise Level: ${worker.noise.toFixed(1)} dB

            Based on this data, provide a response with three distinct sections: "Summary", "Recommendations", and "Incident Log".
            - The "Summary" should be a single, concise sentence explaining the situation.
            - The "Recommendations" should be a numbered list of 3 to 5 immediate, actionable steps for a supervisor.
            - The "Incident Log" should be a brief, formal paragraph suitable for an official report.
        `;

            const systemPrompt = "You are an expert industrial safety officer's assistant AI, named Sentinel. Your task is to provide clear, concise, and actionable advice based on sensor data. Format your response exactly as requested, using Markdown for headers (e.g., '### Summary').";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API error: ${response.status} ${response.statusText}. Check console for details.`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("Received an empty response from the AI. The API key might be invalid or have restrictions.");
                }

                const summary = text.split('### Recommendations')[0].replace('### Summary', '').trim();
                const recommendations = text.split('### Recommendations')[1].split('### Incident Log')[0].trim();
                const incidentLog = text.split('### Incident Log')[1].trim();

                modalContent.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold text-indigo-600 mb-2">Summary</h4>
                    <p class="text-gray-600">${summary}</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-indigo-600 mb-2">Recommended Actions</h4>
                    <div class="prose text-gray-600">${recommendations.replace(/\n/g, '<br>')}</div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-indigo-600 mb-2">Draft Incident Log</h4>
                    <div class="p-4 bg-gray-100 rounded-md">
                        <p id="incident-log-text" class="text-gray-700">${incidentLog}</p>
                    </div>
                    <button id="copy-log-btn" class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-2 px-3 rounded-md transition-colors flex items-center gap-2">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        Copy Log
                    </button>
                </div>
            `;

                document.getElementById('copy-log-btn').addEventListener('click', () => {
                    const logText = document.getElementById('incident-log-text').innerText;
                    const btn = document.getElementById('copy-log-btn');
                    try {
                        navigator.clipboard.writeText(logText);
                        btn.textContent = 'Copied!';
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        btn.textContent = 'Copy Failed';
                    } finally {
                        setTimeout(() => {
                            btn.innerHTML = `<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg> Copy Log`;
                        }, 2000);
                    }
                });

            } catch (error) {
                console.error(error);
                modalContent.innerHTML = `<div class="text-red-600 p-4 bg-red-50 rounded-md"><strong>Failed to get AI assistance.</strong><br>${error.message}</div>`;
            }
        }

        // --- Application Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-page').classList.add('active');
            localStorage.removeItem('sentinelAlerts');
            generateInitialData();
            initializeCharts();

            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(item.dataset.page); }));
            document.getElementById('close-ai-modal').addEventListener('click', () => document.getElementById('ai-modal').classList.add('hidden'));

            document.getElementById('api-key-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const apiKeyInput = document.getElementById('api-key-input');
                localStorage.setItem('geminiApiKey', apiKeyInput.value);
                updateApiKeyStatus(apiKeyInput.value);
                apiKeyInput.value = '';
            });


            logAlert(workers[2], 'High', 'High fatigue detected at shift start.');
            logAlert(workers[1], 'Moderate', 'Multiple yawn events detected via vision system.');

            renderAll();
            setInterval(runDataFeed, 2000);
            document.getElementById('loading-overlay').style.display = 'none';
        });
    </script>

</body>

</html>